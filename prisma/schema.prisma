generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"  // Ganti dari "postgresql" ke "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  password      String
  role          String    @default("STUDENT") // STUDENT, TEACHER, ADMIN
  status        String    @default("ACTIVE") // ACTIVE, SUSPENDED, ALUMNI
  avatar        String?
  lastLogin     DateTime?
  emailVerified Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  student       Student?
  teacher       Teacher?
  admin         Admin?
}

model Student {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  nim       String   @unique
  class     String
  grade     String?
  major     String?
  phone     String?
  address   String?
  
  // Relations
  examParticipants ExamParticipant[]
  examResults      ExamResult[]
  violations       Violation[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Teacher {
  id         String   @id @default(cuid())
  userId     String   @unique
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  nip        String?  @unique
  department String?
  expertise  String[]
  
  // Relations
  questionBanks QuestionBank[]
  exams         Exam[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Admin {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role            String   @default("ADMIN")
  permissions     String[]
  token           String?  @unique
  lastLogin       DateTime?
  
  // Relations
  announcements Announcement[]
  examReports   ExamReport[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model QuestionBank {
  id              String    @id @default(cuid())
  title           String
  description     String?
  category        String    // REGULAR, TRYOUT_UTBK, TRYOUT_SNMPTN, CPNS, CUSTOM
  subject         String?
  difficulty      String    @default("MEDIUM") // EASY, MEDIUM, HARD
  teacherId       String
  teacher         Teacher   @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  tags            String[]
  accessType      String    @default("PRIVATE") // PUBLIC, PRIVATE, RESTRICTED
  isActive        Boolean   @default(true)
  
  // Relations
  questions       Question[]
  exams           Exam[]
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model Question {
  id              String   @id @default(cuid())
  questionBankId  String
  questionBank    QuestionBank @relation(fields: [questionBankId], references: [id], onDelete: Cascade)
  text            String
  type            String   @default("MULTIPLE_CHOICE") // MULTIPLE_CHOICE, ESSAY, TRUE_FALSE
  difficulty      String   @default("MEDIUM")
  points          Int      @default(1)
  imageUrl        String?
  explanation     String?
  
  // Relations
  answers         Answer[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Answer {
  id         String   @id @default(cuid())
  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  text       String
  isCorrect  Boolean  @default(false)
  order      Int
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Exam {
  id              String    @id @default(cuid())
  title           String
  description     String?
  questionBankId  String
  questionBank    QuestionBank @relation(fields: [questionBankId], references: [id], onDelete: Restrict)
  duration        Int       // dalam menit
  startDate       DateTime
  endDate         DateTime
  status          String    @default("DRAFT") // DRAFT, SCHEDULED, ONGOING, COMPLETED, CANCELLED
  passingGrade    Int       @default(70)
  teacherId       String
  teacher         Teacher   @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  accessCode      String    @unique
  isPublished     Boolean   @default(false)
  settings        Json      @default("{}")
  
  // Relations
  participants    ExamParticipant[]
  examResults     ExamResult[]
  violations      Violation[]
  reports         ExamReport[]
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model ExamParticipant {
  id        String   @id @default(cuid())
  examId    String
  exam      Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  studentId String
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  status    String   @default("REGISTERED") // REGISTERED, ATTENDED, ABSENT
  joinedAt  DateTime?
  leftAt    DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([examId, studentId])
}

model ExamResult {
  id            String   @id @default(cuid())
  examId        String
  exam          Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  studentId     String
  student       Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  score         Float
  totalQuestions Int
  correctAnswers Int
  isPassed      Boolean
  timeSpent     Int      // dalam detik
  startedAt     DateTime
  submittedAt   DateTime
  answers       Json     // Menyimpan jawaban siswa
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([examId, studentId])
}

model Violation {
  id        String   @id @default(cuid())
  examId    String
  exam      Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  studentId String
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  type      String   // SWITCH_TAB, MULTIPLE_FACES, NO_FACE, VOICE_DETECTED, etc.
  timestamp DateTime
  severity  String   @default("LOW") // LOW, MEDIUM, HIGH
  actionTaken String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Announcement {
  id              String   @id @default(cuid())
  title           String
  content         String   // Hapus @db.Text
  type            String   @default("INFO")
  priority        String   @default("MEDIUM")
  isPublished     Boolean  @default(false)
  publishDate     DateTime
  expiryDate      DateTime
  attachments     String[]
  createdByAdminId String
  createdByAdmin  Admin    @relation(fields: [createdByAdminId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model FAQ {
  id          String   @id @default(cuid())
  question    String
  answer      String   // Hapus @db.Text
  category    String
  order       Int
  isPublished Boolean  @default(false)
  views       Int      @default(0)
  helpful     Int      @default(0)
  notHelpful  Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ExamReport {
  id               String   @id @default(cuid())
  examId           String
  exam             Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  reportType       String   // PARTICIPANT, PERFORMANCE, VIOLATION, COMPREHENSIVE
  format           String   // PDF, EXCEL, CSV
  status           String   @default("GENERATING") // GENERATING, READY, FAILED
  filePath         String?
  fileName         String
  generatedByAdminId String
  generatedByAdmin Admin    @relation(fields: [generatedByAdminId], references: [id], onDelete: Cascade)
  downloadCount    Int      @default(0)
  lastDownloadedAt DateTime?
  error            String?
  
  generatedAt      DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model SystemSetting {
  id                String   @id @default(cuid())
  key               String   @unique
  value             Json
  description       String?
  category          String   @default("EXAM") // EXAM, SECURITY, GENERAL, NOTIFICATION
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}
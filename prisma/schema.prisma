// Sistem Examo - E-Learning Management System

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// User Management
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String
  role      UserRole @default(STUDENT)
  avatar    String?
  status    UserStatus @default(ACTIVE)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  studentProfile Student?
  teacherProfile Teacher?
  adminProfile   Admin?

  @@map("users")
}

enum UserRole {
  ADMIN
  TEACHER
  STUDENT
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  ALUMNI
}

// Student Profile
model Student {
  id        String   @id @default(cuid())
  userId    String   @unique
  nim       String   @unique
  class     String
  grade     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user         User           @relation(fields: [userId], references: [id])
  examAttempts ExamAttempt[]
  examResults  ExamResult[]

  @@map("students")
}

// Teacher Profile
model Teacher {
  id          String   @id @default(cuid())
  userId      String   @unique
  nip         String?  @unique
  department  String?
  permissions String   // JSON string of permissions
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user        User      @relation(fields: [userId], references: [id])
  questionBanks QuestionBank[]
  examRooms    ExamRoom[]

  @@map("teachers")
}

// Admin Profile
model Admin {
  id          String   @id @default(cuid())
  userId      String   @unique
  permissions String   // JSON string of permissions
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@map("admins")
}

// System Settings
model SystemSetting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  category    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("system_settings")
}

// Question Bank
model QuestionBank {
  id          String           @id @default(cuid())
  title       String
  description String?
  category    ExamCategory
  difficulty  DifficultyLevel  @default(MEDIUM)
  teacherId   String
  isActive    Boolean          @default(true)
  isPublic    Boolean          @default(false)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  // Relations
  teacher   Teacher    @relation(fields: [teacherId], references: [id])
  questions Question[]
  examRooms ExamRoom[]

  @@map("question_banks")
}

enum ExamCategory {
  REGULAR
  TRYOUT_UTBK
  TRYOUT_SNMPTN
  CPNS
  CUSTOM
}

enum DifficultyLevel {
  EASY
  MEDIUM
  HARD
}

// Question
model Question {
  id            String       @id @default(cuid())
  questionBankId String
  type          QuestionType
  question      String
  options       String       // JSON string of options
  correctAnswer String
  explanation   String?
  points        Int          @default(1)
  order         Int
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  // Relations
  questionBank QuestionBank @relation(fields: [questionBankId], references: [id])
  examQuestions ExamQuestion[]

  @@map("questions")
}

enum QuestionType {
  MULTIPLE_CHOICE
  ESSAY
  TRUE_FALSE
  MULTIPLE_ANSWER
}

// Exam Room
model ExamRoom {
  id               String    @id @default(cuid())
  title            String
  description      String?
  questionBankId   String
  teacherId        String
  classCode        String?
  accessType       AccessType @default(ALL)
  allowedStudents  String     // JSON string of NIMs
  allowedClasses   String     // JSON string of class codes
  maxQuestions     Int?
  duration         Int        @default(60) // in minutes
  attemptType      AttemptType @default(SINGLE)
  randomizeOrder   Boolean    @default(false)
  randomizeAnswers Boolean    @default(false)
  isActive         Boolean    @default(false)
  scheduledStart   DateTime?
  scheduledEnd     DateTime?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  // Relations
  questionBank QuestionBank   @relation(fields: [questionBankId], references: [id])
  teacher      Teacher        @relation(fields: [teacherId], references: [id])
  attempts     ExamAttempt[]
  questions    ExamQuestion[]

  @@map("exam_rooms")
}

enum AccessType {
  ALL
  CLASS_RESTRICTED
  STUDENT_RESTRICTED
}

enum AttemptType {
  SINGLE
  UNLIMITED
  LIMITED
}

// Exam Question (junction table with order and randomization)
model ExamQuestion {
  id         String   @id @default(cuid())
  examRoomId String
  questionId String
  order      Int
  createdAt  DateTime @default(now())

  // Relations
  examRoom ExamRoom @relation(fields: [examRoomId], references: [id])
  question Question @relation(fields: [questionId], references: [id])

  @@unique([examRoomId, questionId])
  @@map("exam_questions")
}

// Exam Attempt
model ExamAttempt {
  id          String   @id @default(cuid())
  examRoomId  String
  studentId   String
  status      ExamStatus       @default(IN_PROGRESS)
  startedAt   DateTime         @default(now())
  finishedAt  DateTime?
  timeSpent   Int?             // in seconds
  ipAddress   String?
  userAgent   String?
  violations  String           // JSON string of violations
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  // Relations
  examRoom ExamRoom  @relation(fields: [examRoomId], references: [id])
  student  Student   @relation(fields: [studentId], references: [id])
  answers  ExamAnswer[]
  result   ExamResult?

  @@map("exam_attempts")
}

enum ExamStatus {
  IN_PROGRESS
  COMPLETED
  TERMINATED
  EXPIRED
}

enum ViolationType {
  FULLSCREEN_EXIT
  TAB_SWITCH
  COPY_PASTE
  RIGHT_CLICK
  KEYBOARD_SHORTCUT
}

// Exam Answer
model ExamAnswer {
  id            String   @id @default(cuid())
  attemptId     String
  questionId    String
  answer        String
  isCorrect     Boolean?
  pointsEarned  Int?
  timeSpent     Int?     // in seconds
  answeredAt    DateTime @default(now())

  // Relations
  attempt  ExamAttempt @relation(fields: [attemptId], references: [id])

  @@unique([attemptId, questionId])
  @@map("exam_answers")
}

// Exam Result
model ExamResult {
  id                String   @id @default(cuid())
  attemptId         String   @unique
  studentId         String
  examRoomId        String
  totalQuestions    Int
  correctAnswers    Int
  wrongAnswers      Int
  unanswered        Int
  totalPoints       Int
  earnedPoints      Int
  percentage        Float
  grade             String?
  timeSpent         Int      // in seconds
  violations        String   // JSON string of violations
  submittedAt       DateTime @default(now())
  createdAt         DateTime @default(now())

  // Relations
  attempt ExamAttempt @relation(fields: [attemptId], references: [id])
  student Student    @relation(fields: [studentId], references: [id])

  @@map("exam_results")
}

// Announcement
model Announcement {
  id          String   @id @default(cuid())
  title       String
  content     String
  type        AnnouncementType @default(GENERAL)
  target      AnnouncementTarget @default(ALL)
  examRoomId  String?
  teacherId   String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("announcements")
}

enum AnnouncementType {
  GENERAL
  EXAM_SCHEDULE
  SYSTEM_MAINTENANCE
  FAQ
}

enum AnnouncementTarget {
  ALL
  STUDENTS
  TEACHERS
  ADMINS
}

// FAQ
model FAQ {
  id        String   @id @default(cuid())
  question  String
  answer    String
  category  String
  order     Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("faqs")
}

// Exam Report (Berita Acara)
model ExamReport {
  id          String   @id @default(cuid())
  examRoomId  String
  title       String
  description String?
  statistics  Json?    // JSON object with exam statistics
  issues      String?
  conclusions String?
  createdBy   String   // Admin ID
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("exam_reports")
}

// Activity Log
model ActivityLog {
  id          String   @id @default(cuid())
  userId      String
  action      String
  resource    String
  resourceId  String?
  details     Json?    // JSON object with additional details
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  @@map("activity_logs")
}